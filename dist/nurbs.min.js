!function(i,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(i=i||self).nurbs=e()}(this,function(){"use strict";var b=function(i){return!!i&&(!!i.dtype&&new RegExp("function View[0-9]+d(:?"+i.dtype+")+").test(String(i.constructor)))},h=function(i){return!!i&&(void 0!==i.data&&Array.isArray(i.shape)&&void 0!==i.offset&&void 0!==i.stride)},J=function(i){return Array.isArray(i)||ArrayBuffer.isView(i)};function e(i){if(i){if(b(i)||h(i))return"generic"===i.dtype?e.GENERIC_NDARRAY:e.NDARRAY;if(J(i))return e.ARRAY_OF_ARRAYS;throw new Error("Unhandled data type. Got type: "+typeof i)}}e.ARRAY_OF_ARRAYS="Arr",e.NDARRAY="Nd",e.GENERIC_NDARRAY="GenNd",e.PACKED="PackArr";var L=e;function s(r,i){return function(i,e){void 0===i||Array.isArray(i)||(i=[i]);for(var n=[],t=0;t<i.length;t++)n.push(s.sum(i[t]));if(e)for(i=0;i<n.length;i++)void 0!==e[i]&&(n[i]="("+n[i]+" + "+e[i]+") % "+e[i]);return r+n.join("_")}}var y=function(i,e,n,t,r,s){var o,a,h=[],u=!1;for(o=0;o<i.splineDimension;o++){var f=J(i.knots)&&J(i.knots[o]);f&&(u=!0),h.push("Deg"+i.degree[o]+(f?"":"Uniform")+((a=i.boundary[o])[0].toUpperCase()+a.slice(1)))}var d=[[u?"NU":"",i.weights?"RBS":"BS"].join("")+i.dimension+"D",h.join("_")];return t&&d.push(t+"Pts"),r&&d.push(r+"Wts"),s&&d.push(s+"Kts"),e&&d.push("debug"),n&&d.push("chk"),d.join("_")};s.sum=function(i){return 0===(i=(i=Array.isArray(i)?i:[i]).filter(function(i){return void 0!==i&&0!==i})).length&&i.push(0),i.join(" + ")};var Q=s;function r(r){return function(i,e){void 0===i||Array.isArray(i)||(i=[i]);for(var n=[],t=0;t<i.length;t++)n.push(Q.sum(i[t]));if(e)for(i=0;i<n.length;i++)void 0!==e[i]&&(n[i]="("+n[i]+" + "+e[i]+") % "+e[i]);return r(n)}}function t(n,i){var t;if(i)switch(L(i)){case L.ARRAY_OF_ARRAYS:return r(function(i){return n+"["+i.join("][")+"]"});case L.GENERIC_NDARRAY:return r(function(i){return n+".get("+i.join(",")+")"});case L.NDARRAY:return r(function(i){var e=[n+"Offset"];for(t=0;t<i.length;t++)e.push(n+"Stride"+t+" * ("+i[t]+")");return n+"["+e.join(" + ")+"]"});case L.PACKED:default:return}}function T(i,e){for(var n=1,t=0,r=[];t<i.length;t++)n*=Array.isArray(i[t])?i[t][1]-i[t][0]:i[t],r[t]=Array.isArray(i[t])?i[t][0]:0;for(var s=0;s<n;s++)for(e(r.slice()),t=i.length-1;0<=t;t--){if(r[t]!==(Array.isArray(i[t])?i[t][1]:i[t])-1){r[t]++;break}r[t]=Array.isArray(i[t])?i[t][0]:0}}function X(i,e,n,t){var r,s=[];switch(L(t)){case L.NDARRAY:for(s.push("  var "+e+" = "+n+".data;"),s.push("  var "+e+"Offset = "+n+".offset;"),r=0;r<t.dimension;r++)s.push("  var "+e+"Stride"+r+" = "+n+".stride["+r+"];");break;case L.ARRAY_OF_ARRAYS:s.push("  var "+e+" = "+n+";")}return s.join("\n")}function Z(i,e,n){if(i){if(h(i))return e+".shape["+n+"]";for(var t=e,r=0;r<n;r++)t+="[0]";return t+".length"}return"this.size["+n+"]"}var A=function(i){var e,n={};return(e=t("x",i.points))&&(n.point=e),(e=t("w",i.weights))&&(n.weight=e),(e=t("k",i.knots))&&(n.knot=e),n},l=[],p=[],w=function(i,e,n){if(1!==e)throw new Error("Numerical derivative not implemented for order n = "+e+".");var t,r=void 0===arguments[this.splineDimension+3]?1e-4:arguments[this.splineDimension+3];for(l.length=this.splineDimension,t=0;t<this.splineDimension;t++)l[t+1]=arguments[t+3];var s,o,a,h=this.domain,u=h[n][0],f=h[n][1],d=l[n+1],c=(f-u)*r;for("closed"===this.boundary[n]?(s=u+(d-u-c+(a=f-u))%a,o=u+(d-u+c+a)%a,c*=2):(s=Math.min(f,Math.max(u,d-c)),c=(o=Math.min(f,Math.max(u,d+c)))-s),l[n+1]=s,l[0]=p,this.evaluate.apply(null,l),l[n+1]=o,l[0]=i,this.evaluate.apply(null,l),t=0;t<this.dimension;t++)i[t]=(i[t]-p[t])/c;return i},$={},ii={},R=function(i,e,n,t,r,u,s){var f,d,o,c,l,a,p=e.splineDimension,h=e.points,v=e.degree,m=e.weights,g=void 0!==m,b=e.knots,y=e.dimension,A=e.boundary;if(null!=s){Array.isArray(s)||(s=[s]);var w=0;for(f=0;f<p;f++)void 0===s[f]&&(s[f]=0),w+=s[f];if(g&&1<w)throw new Error("Analytical derivative not implemented for rational b-splines with order n = "+w+".")}u&&(i="Basis"+i),s&&(i="Der"+s.join("_")+"_"+i);var R=$[i];if(t)var k="function"==typeof t?t:console.log;if(R)return t&&k(ii[i]),R.bind(e);var D=[],j="evaluate"+i,E=n.point;u&&(E=function(i,e){for(var n=[],t=0;t<i.length;t++){for(var r=i[t],s=[],o=0;o<r.length;o++)0!==r[o]&&s.push(r[o]);r=s.join(" + "),e[t]&&(r="("+r+" + "+e[t]+") % "+e[t]),n.push(r+" === "+O(t))}return"(("+n.join(" && ")+") ? 1 : 0)"});var _=n.weight,z=n.knot,Y=Q("k"),N=Q("x"),x=Q("w"),O=Q("i"),B=Q("t"),S=t?"domain":"d",F=Q(t?"size":"s"),P=Q(t?"knotIndex":"j"),C=!0;for(l=0;l<p;l++)J(b)&&J(b[l])&&(C=!1);function K(i){D.push("  "+(i||""))}function G(i){t&&K(i)}if(u)var I=[];var M=[];for(f=0;f<p;f++)u&&I.push(O([f])),M.push(B([f]));for(D.push("function "+j+" ("+(u?"":"out, ")+M.join(", ")+(u?", "+I.join(", "):"")+") {"),K("var h, m, a, b;"),r&&(K("var "+S+" = this.domain;"),K("for (var i = 0; i < this.splineDimension; i++) {"),K("  a = arguments[i + 1];"),K("  if (a < "+S+"[i][0] || a > "+S+"[i][1] || a === undefined || isNaN(a)) {"),K("    throw new Error('Invalid Spline parameter in dimension '+i+'. Valid domain is ['+"+S+"[i][0]+', '+"+S+"[i][1]+']. but got t'+i+' = '+arguments[i + 1]+'.');"),K("  }"),K("}")),l=0;l<p;l++)K("var "+F(l)+" = "+Z(h,"this.points",l)+";");function U(i,e,n){return"("+i+") ? ("+e+") : ("+n+")"}D.push(X(0,"x","this.points",h)),g&&D.push(X(0,"w","this.weights",m)),C||D.push(X(0,"k","this.knots",b));var V=[];for(l=0;l<p;l++)switch(L(b)){case L.NDARRAY:V[l]=!0;break;case L.ARRAY_OF_ARRAYS:V[l]=J(b[l])}for(l=0;l<p;l++)if(V[l])for(G("\n  // Bisect to locate the knot interval in dimension "+l+"\n"),K("var "+P(l)+" = 0;"),K("h = "+F(l)+";"),K("while(h > "+P(l)+" + 1) {"),K("  m = 0.5 * (h + "+P(l)+") | 0;"),K("  if ("+z([l,"m"])+" > "+B(l)+") h = m;"),K("  else "+P(l)+" = m;"),K("}"),G("\n  // Fetch knots for dimension "+l+"\n"),f=1-v[l];f<=v[l];f++)"closed"===A[l]?K(f<0?"var "+Y([l,f+v[l]-1])+" = "+U(P(l)+" < "+-f,z([l,0])+" + "+z([l,[F(l),P(l),f]])+" - "+z([l,[F(l)]]),z([l,[P(l),f]]))+";":0<f?"var "+Y([l,f+v[l]-1])+" = "+U(P(l)+" + "+f+" > "+F(l),z([l,F(l)])+" + "+z([l,f+" + "+P(l)+" - "+F(l)])+" - "+z([l,0]),z([l,[P(l),f]]))+";":"var "+Y([l,f+v[l]-1])+" = "+z([l,[P(l),f]])+";"):K("var "+Y([l,f+v[l]-1])+" = "+z([l,[P(l),f]])+";");else{for(G("\n  // Directly compute knot interval for dimension "+l+"\n"),"closed"===A[l]?K(P(l)+" = ("+B(l)+" | 0) % "+F(l)+";"):(K(P(l)+" = ("+B(l)+" | 0);"),K("if ("+P(l)+" < "+v[l]+") "+P(l)+" = "+v[l]+";"),K("if ("+P(l)+" > "+F(l)+" - 1) "+P(l)+" = "+F(l)+" - 1;")),G("\n  // Compute and clamp knots for dimension "+l+"\n"),f=1-v[l];f<=v[l];f++)K("var "+(a=Y([l,f+v[l]-1]))+" = "+P(l)+" + "+f+";");if("clamped"===A[l])for(f=1-v[l];f<=v[l];f++)a=Y([l,f+v[l]-1]),f<0&&K("if ("+a+" < "+v[l]+") "+a+" = "+v[l]+";"),0<f&&K("if ("+a+" > "+F(l)+") "+a+" = "+F(l)+";");"closed"===A[l]&&(G("\n  // Wrap the B-Spline parameter for closed boundary"),K(B(l)+" %= "+F(l)+";"))}for(l=0,o=[];l<p;l++)o[l]=v[l]+1;for(g&&(G("\n  // Fetch weights\n"),T(o,function(i){for(var e=[],n=[],t=0;t<p;t++)e[t]=[P(t),i[t]-v[t]],"closed"===A[t]&&i[t]-v[t]<0&&(n[t]=F(t));K("var "+x(i)+" = "+_(e,n)+";")})),t&&K(g?"\n  // Fetch points and project into homogeneous (weighted) coordinates\n":"\n  // Fetch points\n"),T(o,function(i){for(var e=[],n=[],t=0;t<p;t++)e[t]=[P(t),i[t]-v[t]],"closed"===A[t]&&i[t]-v[t]<0&&(n[t]=F(t));if(u)K(g?"var "+N(i)+" = "+E(e,n)+" * "+x(i)+";":"var "+N(i)+" = "+E(e,n)+";");else for(t=0;t<y;t++){var r=i.concat(t);e[p]=t,K(g?"var "+N(r)+" = "+E(e,n)+" * "+x(i)+";":"var "+N(r)+" = "+E(e,n)+";")}}),G("\n"),G("// Perform De Boor's algorithm"),l=o.length-1;0<=l;l--)for(o[l]=[v[l],v[l]+1],f=0;f<v[l];f++)for(G("\n  // Degree "+v[l]+" evaluation in dimension "+l+", step "+(f+1)+"\n"),d=v[l];f<d;d--){var W=s&&v[l]-f-s[l]<=0;W?(K("m = 1 / ("+Y([l,d-f+v[l]-1])+" - "+Y([l,d-1])+");"),g&&(K("a = ("+B(l)+" - "+Y([l,d-1])+") * m;"),K("b = 1 - a;"))):(K("a = ("+B(l)+" - "+Y([l,d-1])+") / ("+Y([l,d-f+v[l]-1])+" - "+Y([l,d-1])+");"),K("b = 1 - a;")),g&&T(o,function(i){var e=i.slice(),n=i.slice();e[l]=d,n[l]=d-1,W&&g&&K("h = "+x(e)+";"),K(x(e)+" = b * "+x(n)+" + a * "+x(e)+";")}),T(o,function(i){var e,n,t,r=i.slice(),s=i.slice();if(r[l]=d,s[l]=d-1,W){var o=f+1;if(u)e=g?"h * "+x(s)+" / "+x(r)+" * ":"",n=N(r)+(g?" / h":""),t=N(s)+(g?" / "+x(s):""),K(N(r)+" = "+o+" * "+e+"("+n+" - "+t+") * m;");else{var a=r.slice(),h=s.slice();for(c=0;c<y;c++)a[p]=h[p]=c,e=g?"h * "+x(s)+" / "+x(r)+" * ":"",n=N(a)+(g?" / h":""),t=N(h)+(g?" / "+x(s):""),K(N(a)+" = "+o+" * "+e+"("+n+" - "+t+") * m;")}}else if(u)K(N(r)+" = b * "+N(s)+" + a * "+N(r)+";");else for(c=0;c<y;c++)r[p]=s[p]=c,K(N(r)+" = b * "+N(s)+" + a * "+N(r)+";")}),G("\n")}if(t&&K(g?"\n  // Project back from homogeneous coordinates and return final output\n":"\n  // Return final output\n"),u)K(g?"return "+N(v)+" / "+x(v)+";":"return "+N(v)+";");else for(l=0;l<y;l++)K(g?"out["+l+"] = "+N(v.concat([l]))+" / "+x(v)+";":"out["+l+"] = "+N(v.concat([l]))+";");if(u||K("return out;"),D.push("}"),t){var q=D.join("\n");k(q),ii[i]=q}var H=new Function([D.join("\n"),"; return ",j].join(""))();return($[i]=H).bind(e)},g={},k=function(i,e,n,t){var r,s,o,a,h,u,f,d,c=g[i];if(c)return c.bind(e);var l=[],p="transform"+i;l.push("function "+p+"(m) {"),l.push("var i, w;"),l.push(X(0,"x","this.points",e.points));var v=Q(t?"size":"s");for(r=0;r<e.splineDimension;r++)l.push("var "+v(r)+" = "+Z(e.points,"this.points",r)+";");for(a=[],r=0;r<e.splineDimension;r++)o="i"+r,a.push(o),l.push("for ("+o+" = "+v(r)+"- 1; "+o+" >= 0; "+o+"--) {");for(r=0;r<e.dimension;r++)l.push("x"+r+" = "+n.point(a.concat([r])));for(h=[],r=0;r<e.dimension;r++)h.push("m["+((e.dimension+1)*(r+1)-1)+"] * x"+r);for(h.push("m["+((e.dimension+1)*(e.dimension+1)-1)+"]"),l.push("var w = ("+h.join(" + ")+") || 1.0;"),r=0;r<e.dimension;r++){for(h=[],u=e.dimension,s=0;s<u;s++)h.push("m["+(s*(u+1)+r)+"] * x"+s);h.push("m["+(s*(u+1)+r)+"]"),d=n.point(a.concat([r])),f="("+h.join(" + ")+") / w",l.push(d+" = "+f+";")}for(r=e.splineDimension-1;0<=r;r--)l.push("}");l.push("return this;"),l.push("}");var m=new Function([l.join("\n"),"; return ",p].join(""))();return t&&console.log(l.join("\n")),(g[i]=m).bind(e)},E={},D=function(i,e,n,t,r){var s=E[i];if(s)return s.bind(e);var o,a,h,u=e.degree,f=e.knots,d=e.splineDimension,c=e.boundary,l=[],p="support"+i,v=n.knot,m=Q("t"),g=t?"domain":"d",b=Q(t?"size":"s"),y=Q(t?"knotIndex":"i"),A=!0;for(h=0;h<d;h++)J(f)&&J(f[h])&&(A=!1);function w(i){l.push("  "+(i||""))}var R=[];for(o=0;o<d;o++)R.push(m([o]));l.push("function "+p+" (out, "+R.join(", ")+") {");var k=0;for(w("var h, m;"),w("var c = 0;"),r&&(w("var "+g+" = this.domain;"),w("for (var i = 0; i < this.splineDimension; i++) {"),w("  a = arguments[i + 1];"),w("  if (a < "+g+"[i][0] || a > "+g+"[i][1] || a === undefined || isNaN(a)) {"),w("    throw new Error('Invalid Spline parameter in dimension '+i+'. Valid domain is ['+"+g+"[i][0]+', '+"+g+"[i][1]+']. but got t'+i+' = '+arguments[i + 1]+'.');"),w("  }"),w("}")),h=0;h<d;h++)w("var "+b(h)+" = "+Z(e.points,"this.points",h)+";");A||l.push(X(0,"k","this.knots",f));var D=[];for(h=0;h<d;h++)switch(L(f)){case L.NDARRAY:D[h]=!0;break;case L.ARRAY_OF_ARRAYS:D[h]=J(f[h])}for(h=0;h<d;h++)D[h]?(w("var "+y(h)+" = 0;"),w("h = "+b(h)+";"),w("while(h > "+y(h)+" + 1) {"),w("  m = 0.5 * (h + "+y(h)+") | 0;"),w("  if ("+v([h,"m"])+" > "+m(h)+") h = m;"),w("  else "+y(h)+" = m;"),w("}")):"closed"===c[h]?w(y(h)+" = ("+m(h)+" | 0) % "+b(h)+";"):(w(y(h)+" = ("+m(h)+" | 0);"),w("if ("+y(h)+" < "+u[h]+") "+y(h)+" = "+u[h]+";"),w("if ("+y(h)+" > "+b(h)+" - 1) "+y(h)+" = "+b(h)+" - 1;"));for(h=0,a=[];h<d;h++)a[h]=u[h]+1;T(a,function(i){for(var e,n,t=[],r=[],s=0;s<d;s++)t[s]=[y(s),i[s]-u[s]],"closed"===c[s]&&i[s]-u[s]<0&&(r[s]=b(s));for(s=0;s<d;s++)e=t[s],w(void 0===(n=r[s])?"out["+k+++"] = "+e.join(" + ")+";":"out["+k+++"] = ("+e.join(" + ")+" + "+n+") % "+n+";")}),w("out.length = "+k+";"),w("return out;"),l.push("}"),t&&console.log(l.join("\n"));var j=new Function([l.join("\n"),"; return ",p].join(""))();return(E[i]=j).bind(e)},j={open:"open",closed:"closed",clamped:"clamped"};function _(i){return null==i}function u(){var i,e=[],n=this.points;n?h(n)&&(i=n.shape):i=this.size;for(var t=0;t<this.splineDimension;t++){var r=i?i[t]:n.length,s=this.degree[t],o="closed"===this.boundary[t];if(this.knots&&this.knots[t]){var a=this.knots[t];e[t]=[a[o?0:s],a[r]]}else e[t]=[o?0:s,r];n=n&&n[0]}return e}return function(i,e,n,t,r,s){var o=function(i,e,n,t,r,s){return a(i,e,n,t,r,s),o},a=function(i,e,n,t,r,s){var o,a;!i||J(i)||b(i)?(s=s||{},this.weights=t,this.knots=n,this.degree=e,this.points=i,this.boundary=r,this.debug=s.debug,this.checkBounds=!!s.checkBounds):(s=i,this.debug=i.debug,this.checkBounds=!!i.checkBounds,this.weights=i.weights,this.knots=i.knots,this.degree=i.degree,this.boundary=i.boundary,this.points=i.points),Object.defineProperty(this,"size",{value:s.size,writable:!0,configurable:!0});var h=L(this.points),u=L(this.weights),f=L(this.knots);if(this.points)switch(h){case L.GENERIC_NDARRAY:case L.NDARRAY:Object.defineProperties(this,{splineDimension:{value:this.points.shape.length-1,writable:!1,configurable:!0},dimension:{value:this.points.shape[this.points.shape.length-1],writable:!1,configurable:!0},size:{get:function(){return this.points.shape.slice(0,this.points.shape.length-1)},set:function(){throw new Error("Cannot assign to read only property 'size'")},configurable:!0}});break;case L.ARRAY_OF_ARRAYS:var d=0,c=this.size||[];c.length=0;for(var l=this.points;J(l[0]);l=l[0])d++,c.push(l.length);if(0===d)throw new Error("Expected an array of points");Object.defineProperties(this,{splineDimension:{value:d,writable:!1,configurable:!0},dimension:{value:l.length,writable:!1,configurable:!0},size:{get:function(){for(var i=[],e=i.length=0,n=this.points;e<this.splineDimension;e++,n=n[0])i[e]=n.length;return i},set:function(){throw new Error("Cannot assign to read only property 'size'")},configurable:!0}});break;case L.PACKED:default:throw new Error("Expected either a packed array, array of arrays, or ndarray of points")}else{if(void 0===this.size||null===this.size)throw new Error("Either points or a control hull size must be provided.");if(J(this.size)||Object.defineProperty(this,"size",{value:[this.size],writable:!0,configurable:!0}),0===this.size.length)throw new Error("`size` must be a number or an array of length at least one.");Object.defineProperties(this,{splineDimension:{value:this.size.length,writable:!1,configurable:!0},dimension:{value:0,writable:!1,configurable:!0}})}if(J(this.degree)){for(o=0;o<this.splineDimension;o++)if(_(this.degree[o]))throw new Error("Missing degree in dimension "+(o+1))}else{var p=!_(this.degree),v=_(this.degree)?2:this.degree;for(this.degree=[],o=0;o<this.splineDimension;o++)if(this.size[o]<=v){if(p)throw new Error("Expected at least "+(v+1)+" points for degree "+v+" spline in dimension "+(o+1)+" but got only "+this.size[o]);this.degree[o]=this.size[o]-1}else this.degree[o]=v}if(a="string"!=typeof this.boundary?"open":this.boundary,!j[a])throw new Error("Boundary type must be one of "+Object.keys(j)+". Got "+a);for(this.boundary=J(this.boundary)?this.boundary:[],this.boundary.length=this.splineDimension,o=0;o<this.splineDimension;o++)if(this.boundary[o]=_(this.boundary[o])?a:this.boundary[o],!j[a])throw new Error("Boundary type must be one of "+Object.keys(j)+". Got "+a+" for dimension "+(o+1));switch(f){case L.ARRAY_OF_ARRAYS:for(J(this.knots)&&0<this.knots.length&&!J(this.knots[0])&&(this.knots=[this.knots]),o=0;o<this.splineDimension;o++){if(this.size[o]<=this.degree[o])throw new Error("Expected at least "+(this.degree[o]+1)+" points in dimension "+(o+1)+" but got "+this.size[o]+".");if(J(this.knots[o])){if("closed"!==this.boundary[o]&&this.knots[o].length!==this.degree[o]+this.size[o]+1)throw new Error("Expected "+(this.degree[o]+this.size[o]+1)+" knots in dimension "+(o+1)+" but got "+this.knots[o].length+".");if("closed"===this.boundary[o]&&this.knots[o].length!==this.size[o]+1&&!(this.knots[o].length===this.size[o]+this.degree[o]+1))throw new Error("Expected "+(this.size[o]+1)+" knots for closed spline in dimension "+(o+1)+" but got "+this.knots[o].length+".")}}}var m=y(this,this.debug,this.checkBounds,h,u,f);if(m!==this.__cacheKey){this.__cacheKey=m;var g=A(this);this.evaluate=R(this.__cacheKey,this,g,this.debug,this.checkBounds,!1),this.transform=k(this.__cacheKey,this,g,this.debug),this.support=D(this.__cacheKey,this,g,this.debug,this.checkBounds),this.evaluator=function(i,e){return R(this.__cacheKey,this,g,this.debug,this.checkBounds,e,i)}}return this.numericalDerivative=w.bind(this),this}.bind(o);return Object.defineProperty(o,"domain",{get:u}),a(i,e,n,t,r,s),o}});